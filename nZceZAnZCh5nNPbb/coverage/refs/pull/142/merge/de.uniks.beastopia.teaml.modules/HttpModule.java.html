<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpModule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stp-23-team-lumnix</a> &gt; <a href="index.source.html" class="el_package">de.uniks.beastopia.teaml.modules</a> &gt; <span class="el_source">HttpModule.java</span></div><h1>HttpModule.java</h1><pre class="source lang-java linenums">package de.uniks.beastopia.teaml.modules;

import com.fasterxml.jackson.databind.ObjectMapper;
import dagger.Module;
import dagger.Provides;
import de.uniks.beastopia.teaml.Main;
import de.uniks.beastopia.teaml.rest.*;
import de.uniks.beastopia.teaml.service.TokenStorage;
import javafx.util.Pair;
import okhttp3.*;
import retrofit2.Retrofit;
import retrofit2.adapter.rxjava3.RxJava3CallAdapterFactory;
import retrofit2.converter.jackson.JacksonConverterFactory;

import javax.inject.Singleton;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.concurrent.Semaphore;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;


@Module
<span class="fc" id="L26">public class HttpModule {</span>
<span class="fc" id="L27">    public record EndpointRateLimit(</span>
            String endpoint,
            int maxRequests,
            int timeFrameSeconds
    ) {
    }

<span class="fc" id="L34">    private static final List&lt;EndpointRateLimit&gt; ENDPOINT_RATE_LIMITS = List.of(</span>
            new EndpointRateLimit(&quot;auth/.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;achievements.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;monsters/.*/image&quot;, 210, 61),
            new EndpointRateLimit(&quot;items/.*/image&quot;, 60, 61),
            new EndpointRateLimit(&quot;characters/.*\\.png&quot;, 90, 61),
            new EndpointRateLimit(&quot;tilesets/.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;characters.*&quot;, 90, 61),
            new EndpointRateLimit(&quot;users.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;groups.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;messages.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;trainers.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;abilities.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;regions.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;areas.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;monsters.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;encounters.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;opponents.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;items.*&quot;, 10, 11),
            new EndpointRateLimit(&quot;default&quot;, 10, 11)
    );

    private static final HashMap&lt;String, List&lt;Pair&lt;Date, String&gt;&gt;&gt; LAST_REQUESTS;
    private static final HashMap&lt;String, List&lt;Pair&lt;Date, String&gt;&gt;&gt; ALL_REQUESTS;
    private static final HashMap&lt;String, Semaphore&gt; SEMAPHORES;

    static {
<span class="fc" id="L61">        LAST_REQUESTS = new HashMap&lt;&gt;();</span>
<span class="fc" id="L62">        ALL_REQUESTS = new HashMap&lt;&gt;();</span>
<span class="fc" id="L63">        SEMAPHORES = new HashMap&lt;&gt;();</span>
<span class="fc" id="L64">        ENDPOINT_RATE_LIMITS.forEach(endpoint -&gt; SEMAPHORES.put(endpoint.endpoint(), new Semaphore(1)));</span>
<span class="fc" id="L65">        ENDPOINT_RATE_LIMITS.forEach(endpoint -&gt; LAST_REQUESTS.put(endpoint.endpoint(), new ArrayList&lt;&gt;()));</span>
<span class="fc" id="L66">        ENDPOINT_RATE_LIMITS.forEach(endpoint -&gt; ALL_REQUESTS.put(endpoint.endpoint(), new ArrayList&lt;&gt;()));</span>
<span class="fc" id="L67">    }</span>

    private static int historySize(EndpointRateLimit endpointLimit) {
<span class="nc" id="L70">        return ALL_REQUESTS.get(endpointLimit.endpoint()).stream()</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                .filter(p -&gt; p.getKey().getTime() &gt;= new Date().getTime() - endpointLimit.timeFrameSeconds() * 1000L)</span>
<span class="nc" id="L72">                .toList().size();</span>
    }


    private static boolean wouldExceedRateLimit(EndpointRateLimit endpointLimit) {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        return historySize(endpointLimit) &gt;= endpointLimit.maxRequests();</span>
    }

    private static void cleanupOldRequests(EndpointRateLimit endpointLimit) {
<span class="nc" id="L81">        long currentTime = new Date().getTime();</span>
<span class="nc" id="L82">        long timeBeginFrame = currentTime - (endpointLimit.timeFrameSeconds() * 1000L);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        ALL_REQUESTS.get(endpointLimit.endpoint()).removeIf(pair -&gt; pair.getKey().getTime() &lt; timeBeginFrame);</span>
<span class="nc" id="L84">    }</span>

    private static final int MAX_REQUESTS = 32;

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    static OkHttpClient client(TokenStorage tokenStorage) {
<span class="nc" id="L92">        ThreadPoolExecutor executor = new ThreadPoolExecutor(MAX_REQUESTS, MAX_REQUESTS, 1, TimeUnit.SECONDS, new java.util.concurrent.LinkedBlockingQueue&lt;&gt;());</span>
<span class="nc" id="L93">        Dispatcher dispatcher = new Dispatcher(executor);</span>
<span class="nc" id="L94">        executor.prestartAllCoreThreads();</span>
<span class="nc" id="L95">        dispatcher.setMaxRequests(MAX_REQUESTS);</span>
<span class="nc" id="L96">        dispatcher.setMaxRequestsPerHost(MAX_REQUESTS);</span>

<span class="nc" id="L98">        return new OkHttpClient.Builder()</span>
<span class="nc" id="L99">                .dispatcher(dispatcher)</span>
<span class="nc" id="L100">                .addInterceptor(chain -&gt; {</span>
<span class="nc" id="L101">                    String requestUrl = chain.request().url().toString();</span>
<span class="nc" id="L102">                    EndpointRateLimit endpointRateLimit = ENDPOINT_RATE_LIMITS.stream()</span>
<span class="nc" id="L103">                            .filter(endpoint -&gt; requestUrl.matches(&quot;.*&quot; + endpoint.endpoint() + &quot;.*&quot;))</span>
<span class="nc" id="L104">                            .findFirst()</span>
<span class="nc" id="L105">                            .orElse(ENDPOINT_RATE_LIMITS.get(ENDPOINT_RATE_LIMITS.size() - 1));</span>

<span class="nc" id="L107">                    String endpoint = endpointRateLimit.endpoint();</span>
<span class="nc" id="L108">                    Semaphore semaphore = SEMAPHORES.get(endpoint);</span>
                    try {
<span class="nc" id="L110">                        semaphore.acquire();</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">                        while (wouldExceedRateLimit(endpointRateLimit)) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                            if (chain.call().isCanceled()) {</span>
<span class="nc" id="L114">                                throw new InterruptedException();</span>
                            }

                            //noinspection BusyWait
<span class="nc" id="L118">                            Thread.sleep(100);</span>
//                            System.out.println(&quot;waiting...&quot;);
                        }

<span class="nc" id="L122">                        cleanupOldRequests(endpointRateLimit);</span>

<span class="nc" id="L124">                        Pair&lt;Date, String&gt; request = new Pair&lt;&gt;(new Date(), chain.request().url().toString());</span>
<span class="nc" id="L125">                        LAST_REQUESTS.get(endpoint).add(request);</span>
<span class="nc" id="L126">                        ALL_REQUESTS.get(endpoint).add(request);</span>

<span class="nc" id="L128">                        final String token = tokenStorage.getAccessToken();</span>
<span class="nc" id="L129">                        System.out.println(&quot;Request: &quot; + chain.request().url() + &quot; [&quot; + endpointRateLimit.endpoint() + &quot; - &quot; + historySize(endpointRateLimit) + &quot;/&quot; + endpointRateLimit.maxRequests() + &quot;]&quot;);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                        if (token == null) {</span>
<span class="nc" id="L131">                            return chain.proceed(chain.request());</span>
                        }
<span class="nc" id="L133">                        final Request newRequest = chain</span>
<span class="nc" id="L134">                                .request()</span>
<span class="nc" id="L135">                                .newBuilder()</span>
<span class="nc" id="L136">                                .addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + token)</span>
<span class="nc" id="L137">                                .build();</span>

<span class="nc" id="L139">                        Response response = chain.proceed(newRequest);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                        while (response.code() == 429) {</span>
<span class="nc" id="L141">                            System.out.println(&quot;RATE LIMIT EXCEEDED\nLast &quot; + endpointRateLimit.timeFrameSeconds() + &quot; seconds requests were:&quot;);</span>

<span class="nc" id="L143">                            List&lt;Pair&lt;Date, String&gt;&gt; list = ALL_REQUESTS.get(endpoint).stream()</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                                    .filter(p -&gt; p.getKey().getTime() &gt; new Date().getTime() - endpointRateLimit.timeFrameSeconds() * 1000L)</span>
<span class="nc" id="L145">                                    .toList();</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">                            for (Pair&lt;Date, String&gt; pair : list) {</span>
<span class="nc" id="L148">                                System.out.println(&quot;\t&quot; + pair.getKey() + &quot; &quot; + pair.getValue());</span>
<span class="nc" id="L149">                            }</span>

<span class="nc" id="L151">                            System.out.println(&quot;Total count: &quot; + list.size());</span>
                            //noinspection BusyWait
<span class="nc" id="L153">                            Thread.sleep(1000);</span>
<span class="nc" id="L154">                            response.close();</span>

<span class="nc" id="L156">                            semaphore.release();</span>
<span class="nc" id="L157">                            response = chain.call().clone().execute();</span>
<span class="nc" id="L158">                            semaphore.acquire();</span>
<span class="nc" id="L159">                        }</span>
<span class="nc" id="L160">                        return response;</span>

<span class="nc" id="L162">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L163">                        System.out.println(&quot;Request was interrupted&quot;);</span>
<span class="nc" id="L164">                        return new Response.Builder()</span>
<span class="nc" id="L165">                                .code(500)</span>
<span class="nc" id="L166">                                .body(ResponseBody.create(MediaType.parse(&quot;text/json&quot;), &quot;{}&quot;))</span>
<span class="nc" id="L167">                                .message(&quot;Request was interrupted&quot;)</span>
<span class="nc" id="L168">                                .protocol(Protocol.HTTP_2)</span>
<span class="nc" id="L169">                                .request(chain.request())</span>
<span class="nc" id="L170">                                .build();</span>
                    } finally {
<span class="nc" id="L172">                        semaphore.release();</span>
                    }
<span class="nc" id="L174">                }).build();</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    Retrofit retrofit(OkHttpClient client, ObjectMapper objectMapper) {
<span class="nc" id="L181">        return new Retrofit.Builder()</span>
<span class="nc" id="L182">                .baseUrl(Main.API_URL + &quot;/&quot;)</span>
<span class="nc" id="L183">                .client(client)</span>
<span class="nc" id="L184">                .addConverterFactory(JacksonConverterFactory.create(objectMapper))</span>
<span class="nc" id="L185">                .addCallAdapterFactory(RxJava3CallAdapterFactory.create())</span>
<span class="nc" id="L186">                .build();</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    UserApiService user(Retrofit retrofit) {
<span class="nc" id="L193">        return retrofit.create(UserApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    AuthApiService auth(Retrofit retrofit) {
<span class="nc" id="L200">        return retrofit.create(AuthApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    GroupApiService group(Retrofit retrofit) {
<span class="nc" id="L207">        return retrofit.create(GroupApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    MessageApiService message(Retrofit retrofit) {
<span class="nc" id="L214">        return retrofit.create(MessageApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    RegionApiService region(Retrofit retrofit) {
<span class="nc" id="L221">        return retrofit.create(RegionApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    AreaApiService area(Retrofit retrofit) {
<span class="nc" id="L228">        return retrofit.create(AreaApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    PresetsApiService presets(Retrofit retrofit) {
<span class="nc" id="L235">        return retrofit.create(PresetsApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    TrainerApiService trainer(Retrofit retrofit) {
<span class="nc" id="L242">        return retrofit.create(TrainerApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    AchievementsApiService achievements(Retrofit retrofit) {
<span class="nc" id="L249">        return retrofit.create(AchievementsApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    RegionEncountersApiService regionEncounters(Retrofit retrofit) {
<span class="nc" id="L256">        return retrofit.create(RegionEncountersApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    EncounterOpponentsApiService encounterOpponents(Retrofit retrofit) {
<span class="nc" id="L263">        return retrofit.create(EncounterOpponentsApiService.class);</span>
    }

    @Provides
    @Singleton
    @SuppressWarnings(&quot;unused&quot;)
    TrainerItemsApiService trainerItems(Retrofit retrofit) {
<span class="nc" id="L270">        return retrofit.create(TrainerItemsApiService.class);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>